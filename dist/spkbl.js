!function(s,n){"use strict";var r={selector:".spkbl",insert:"before",multivoice:!0},e={play:"Text vorlesen",pause:"Pause",progress:"Fortschritt",stop:"Schließen"},t=["address","article","aside","blockquote","details","dialog","dd","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","li","main","nav","ol","p","pre","section","table","ul"];function i(e,t){this.lang=e,this.multivoice=t,this.items=[]}i.prototype._parse=function(e){var s=this;return e.childNodes.forEach(function(e){var t;e.nodeType===Element.ELEMENT_NODE?(t=s.multivoice&&e.lang||s.lang,s.items.push({type:1+s._isBlockLevelElement(e),lang:t,node:e,items:new i(t,s.multivoice)._parse(e)})):e.nodeType!==Element.TEXT_NODE||(t=e.nodeValue.trim().replace(/[\s\r\n]+/g," ")).length&&s.items.push({type:0,lang:s.lang,node:e,text:t})}),this.items},i.prototype._isBlockLevelElement=function(e){return-1!==t.indexOf(e.tagName.toLowerCase())},i.prototype.chunked=function(e){var s=[],n=null,r=function(e){if(null===n)n=e.type?(n={lang:e.lang,chunks:[]},e.items.forEach(r),s.push(n),null):{lang:e.lang,chunks:[{node:e.node,text:e.text}]};else switch(e.type){case 2:n.chunks.length?(s.push(n),n={lang:e.lang,chunks:[]}):n.lang=e.lang,e.items.forEach(r),n.chunks.length&&s.push(n),n=null;break;case 1:var t;e.lang===n.lang?e.items.forEach(r):(t=n.lang,n.chunks.length&&s.push(n),n={lang:e.lang,chunks:[]},e.items.forEach(r),n.chunks.length&&s.push(n),n={lang:t,chunks:[]});break;default:n.chunks.push({node:e.node,text:e.text})}};if(this._parse(e).forEach(r),n&&n.chunks.length&&s.push(n),s.length){var t=[s.shift()];do{var i=s.shift(),o=t.length-1;i.lang===t[o].lang?Array.prototype.push.apply(t[o].chunks,i.chunks):t.push(i)}while(s.length);return t.forEach(function(e){var t=0;e.chunks.forEach(function(e){e.char=t,a.test(e.text.substr(-1))||(e.text+="."),t+=e.text.length+1})}),t}return[]};var o=[],l=null,a=/[’'‘’`“”"\[\]\(\){}…,\.!;\?\-:\u0964\u0965]/;function h(e,t){this.element=e,this.options=t,this._utterances=[],this._currentUtterance=0,this._length=0,this._offset=0,this._progress=0,this._player=null,this._controls={},this._buildPlayer(),this._injectPlayer();t=new i(this._determineLanguage(this.element)||"en",this.options.multivoice);this._setUtterances(t.chunked(this.element))}h.prototype._determineLanguage=function(e){return e.lang||(e.parentNode?this._determineLanguage(e.parentNode):null)},h.prototype._buildPlayer=function(){this._player=n.createElement("div"),this._player.className="spkbl-player spkbl-player--inactive",this._player.role="group",this._controls.play=n.createElement("button"),this._controls.play.type="button",this._controls.play.className="spkbl-ctrl spkbl-ctrl--play",this._controls.play.addEventListener("click",this.play.bind(this)),this._controls.play.appendChild(n.createTextNode(e.play)),this._player.appendChild(this._controls.play),this._controls.pause=n.createElement("button"),this._controls.pause.type="button",this._controls.pause.className="spkbl-ctrl spkbl-ctrl--pause",this._controls.pause.addEventListener("click",this.pause.bind(this)),this._controls.pause.appendChild(n.createTextNode(e.pause)),this._controls.pause.setAttribute("aria-pressed","false"),this._player.appendChild(this._controls.pause),this._controls.progress=n.createElement("progress"),this._controls.progress.className="spkbl-ctrl spkbl-ctrl--progress",this._controls.progress.max="100",this._controls.progress.value="0",this._controls.progress.setAttribute("aria-label",e.progress),this._controls.progress.setAttribute("aria-hidden","true"),this._controls.progress.setAttribute("readonly","true"),this._controls.progress.appendChild(n.createTextNode("0%")),this._player.appendChild(this._controls.progress),this._controls.stop=n.createElement("button"),this._controls.stop.type="button",this._controls.stop.className="spkbl-ctrl spkbl-ctrl--stop",this._controls.stop.addEventListener("click",this.stop.bind(this)),this._controls.stop.appendChild(n.createTextNode(e.stop)),this._player.appendChild(this._controls.stop)},h.prototype._setUtterances=function(e){var t=this;this._length=0,this._utterances=e.map(function(e){return e.text=e.chunks.map(function(e){return e.text}).join(" "),e.length=e.text.length,t._length+=e.length+1,e}),console.table(this._utterances),--this._length},h.prototype.play=function(e){this._player.classList.add("spkbl-player--active"),this._player.classList.remove("spkbl-player--inactive"),this._controls.pause.focus(),this._currentUtterance=-1,this._offset=0,this._progress=0,speechSynthesis.cancel(),l.onboundary=this.boundary.bind(this),l.onend=this.next.bind(this),this.next(e)},h.prototype.next=function(e){var t;this._utterances.length>this._currentUtterance+1?(0<=this._currentUtterance&&(this._offset+=this._utterances[this._currentUtterance].length+1),t=this._utterances[++this._currentUtterance],l.text=t.text,l.voice=this._getUtteranceVoice(t),speechSynthesis.speak(l)):this.stop(e)},h.prototype._getUtteranceVoice=function(t){return t.voice||(t.voice=o.find(function(e){return e.lang===t.lang||e.lang.startsWith(t.lang+"-")})||o.find(function(e){return e.default})||o[0]),t.voice},h.prototype.boundary=function(e){this._progress=Math.round(100*(this._offset+e.charIndex)/this._length),this._controls.progress.value=this._progress,this._controls.progress.textContent=this._progress+"%",console.debug(this._progress,e.name,l.text.substr(e.charIndex,e.charLength))},h.prototype.pause=function(e){speechSynthesis.speaking&&(speechSynthesis.paused?(speechSynthesis.resume(),this._player.classList.remove("spkbl-player--paused"),this._controls.pause.setAttribute("aria-pressed","false")):(speechSynthesis.pause(),this._player.classList.add("spkbl-player--paused"),this._controls.pause.setAttribute("aria-pressed","true")))},h.prototype.stop=function(e){l.onboundary=null,l.onend=null,speechSynthesis.cancel(),this._player.classList.add("spkbl-player--inactive"),this._player.classList.remove("spkbl-player--active"),this._player.classList.remove("spkbl-player--paused"),this._controls.play.focus()},h.prototype._injectPlayer=function(){if("function"!=typeof this.options.insert)switch(this.options.insert){case"before":this.element.parentNode.insertBefore(this._player,this.element);break;case"after":this.element.parentNode.insertBefore(this._player,this.element.nextSibling);break;default:this.element.insertBefore(this._player,this.element.firstChild)}else this.options.insert(this.element,this._player)},h.init=function(e){if(void 0===e&&(e={}),"SpeechSynthesisUtterance"in s){(l=new SpeechSynthesisUtterance).volume=1,l.pitch=1,l.rate=1,o=speechSynthesis.getVoices(),speechSynthesis.addEventListener("voiceschanged",function(){o=speechSynthesis.getVoices()});var t=Object.assign(r,e),e=t.selector||"";return e.length?Array.from(n.querySelectorAll(e)).map(function(e){return new h(e,t)}):[]}return[]},"undefined"!=typeof exports?exports.Speakable=h:s.Speakable=h}("undefined"!=typeof global?global:window,document);