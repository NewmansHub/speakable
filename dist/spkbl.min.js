var __spreadArrays=this&&this.__spreadArrays||function(){for(var e=0,t=0,s=arguments.length;t<s;t++)e+=arguments[t].length;for(var n=Array(e),r=0,t=0;t<s;t++)for(var i=arguments[t],o=0,l=i.length;o<l;o++,r++)n[r]=i[o];return n};!function(s,n){"use strict";var r={selector:".spkbl",insert:"before",multivoice:!0},i={ctrl:{play:"Read text",pause:"Pause",progress:"Progress",stop:"Resume"}},t=["address","article","aside","blockquote","details","dialog","dd","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","li","main","nav","ol","p","pre","section","table","ul"];function o(e,t){this.lang=e,this.multivoice=t,this.items=[]}function l(e){return e&&"object"==typeof e&&!Array.isArray(e)}function a(e){for(var t,s=[],n=1;n<arguments.length;n++)s[n-1]=arguments[n];if(!s.length)return e;var r=s.shift();if(l(e)&&l(r))for(var i in r)l(r[i])?(e[i]||Object.assign(e,((t={})[i]={},t)),a(e[i],r[i])):Object.assign(e,((t={})[i]=r[i],t));return a.apply(void 0,__spreadArrays([e],s))}o.prototype._parse=function(e){var s=this;return e.childNodes.forEach(function(e){var t;e.nodeType===Element.ELEMENT_NODE?(t=s.multivoice&&e.lang||s.lang,s.items.push({type:1+s._isBlockLevelElement(e),lang:t,node:e,items:new o(t,s.multivoice)._parse(e)})):e.nodeType!==Element.TEXT_NODE||(t=e.nodeValue.trim().replace(/[\s\r\n]+/g," ")).length&&s.items.push({type:0,lang:s.lang,node:e,text:t})}),this.items},o.prototype._isBlockLevelElement=function(e){return-1!==t.indexOf(e.tagName.toLowerCase())},o.prototype.chunked=function(e){var s=[],n=null,r=function(e){if(null===n)n=e.type?(n={lang:e.lang,chunks:[]},e.items.forEach(r),s.push(n),null):{lang:e.lang,chunks:[{node:e.node,text:e.text}]};else switch(e.type){case 2:n.chunks.length?(s.push(n),n={lang:e.lang,chunks:[]}):n.lang=e.lang,e.items.forEach(r),n.chunks.length&&s.push(n),n=null;break;case 1:var t;e.lang===n.lang?e.items.forEach(r):(t=n.lang,n.chunks.length&&s.push(n),n={lang:e.lang,chunks:[]},e.items.forEach(r),n.chunks.length&&s.push(n),n={lang:t,chunks:[]});break;default:n.chunks.push({node:e.node,text:e.text})}};if(this._parse(e).forEach(r),n&&n.chunks.length&&s.push(n),s.length){var t=[s.shift()];do{var i=s.shift(),o=t.length-1;i.lang===t[o].lang?Array.prototype.push.apply(t[o].chunks,i.chunks):t.push(i)}while(s.length);return t.forEach(function(e){var t=0;e.chunks.forEach(function(e){e.char=t,c.test(e.text.substr(-1))||(e.text+="."),t+=e.text.length+1})}),t}return[]};var h=[],p=null,c=/[’'‘’`“”"\[\]\(\){}…,\.!;\?\-:\u0964\u0965]/;function u(e,t){this.element=e,this.options=t,this.l18n=a(i,this.options.l18n||{}),console.log(this.l18n),this._utterances=[],this._currentUtterance=0,this._length=0,this._offset=0,this._progress=0,this._player=null,this._controls={},this._buildPlayer(),this._injectPlayer();t=new o(this._determineLanguage(this.element)||"en",this.options.multivoice);this._setUtterances(t.chunked(this.element))}u.prototype._determineLanguage=function(e){return e.lang||(e.parentNode?this._determineLanguage(e.parentNode):null)},u.prototype._buildPlayer=function(){this._player=n.createElement("div"),this._player.className="spkbl-player spkbl-player--inactive",this._player.role="group",this._controls.play=n.createElement("button"),this._controls.play.type="button",this._controls.play.className="spkbl-ctrl spkbl-ctrl--play",this._controls.play.addEventListener("click",this.play.bind(this)),this._controls.play.appendChild(n.createTextNode(this.l18n.ctrl.play)),this._player.appendChild(this._controls.play),this._controls.pause=n.createElement("button"),this._controls.pause.type="button",this._controls.pause.className="spkbl-ctrl spkbl-ctrl--pause",this._controls.pause.addEventListener("click",this.pause.bind(this)),this._controls.pause.appendChild(n.createTextNode(this.l18n.ctrl.pause)),this._controls.pause.setAttribute("aria-pressed","false"),this._player.appendChild(this._controls.pause),this._controls.progress=n.createElement("progress"),this._controls.progress.className="spkbl-ctrl spkbl-ctrl--progress",this._controls.progress.max="100",this._controls.progress.value="0",this._controls.progress.setAttribute("aria-label",this.l18n.ctrl.progress),this._controls.progress.setAttribute("aria-hidden","true"),this._controls.progress.setAttribute("readonly","true"),this._controls.progress.appendChild(n.createTextNode("0%")),this._player.appendChild(this._controls.progress),this._controls.stop=n.createElement("button"),this._controls.stop.type="button",this._controls.stop.className="spkbl-ctrl spkbl-ctrl--stop",this._controls.stop.addEventListener("click",this.stop.bind(this)),this._controls.stop.appendChild(n.createTextNode(this.l18n.ctrl.stop)),this._player.appendChild(this._controls.stop)},u.prototype._setUtterances=function(e){var t=this;this._length=0,this._utterances=e.map(function(e){return e.text=e.chunks.map(function(e){return e.text}).join(" "),e.length=e.text.length,t._length+=e.length+1,e}),console.table(this._utterances),--this._length},u.prototype.play=function(e){this._player.classList.add("spkbl-player--active"),this._player.classList.remove("spkbl-player--inactive"),this._controls.pause.focus(),this._currentUtterance=-1,this._offset=0,this._progress=0,speechSynthesis.cancel(),p.onboundary=this.boundary.bind(this),p.onend=this.next.bind(this),this.next(e)},u.prototype.next=function(e){var t;this._utterances.length>this._currentUtterance+1?(0<=this._currentUtterance&&(this._offset+=this._utterances[this._currentUtterance].length+1),t=this._utterances[++this._currentUtterance],p.text=t.text,p.voice=this._getUtteranceVoice(t),speechSynthesis.speak(p)):this.stop(e)},u.prototype._getUtteranceVoice=function(t){return t.voice||(t.voice=h.find(function(e){return e.lang===t.lang||e.lang.startsWith(t.lang+"-")})||h.find(function(e){return e.default})||h[0]),t.voice},u.prototype.boundary=function(e){this._progress=Math.round(100*(this._offset+e.charIndex)/this._length),this._controls.progress.value=this._progress,this._controls.progress.textContent=this._progress+"%",console.debug(this._progress,e.name,p.text.substr(e.charIndex,e.charLength))},u.prototype.pause=function(e){console.log(speechSynthesis.speaking,speechSynthesis.paused),speechSynthesis.speaking&&(speechSynthesis.paused?(speechSynthesis.resume(),this._player.classList.remove("spkbl-player--paused"),this._controls.pause.setAttribute("aria-pressed","false")):(speechSynthesis.pause(),console.log(speechSynthesis.paused),this._player.classList.add("spkbl-player--paused"),this._controls.pause.setAttribute("aria-pressed","true")))},u.prototype.stop=function(e){p.onboundary=null,p.onend=null,speechSynthesis.cancel(),this._player.classList.add("spkbl-player--inactive"),this._player.classList.remove("spkbl-player--active"),this._player.classList.remove("spkbl-player--paused"),this._controls.play.focus()},u.prototype._injectPlayer=function(){if("function"!=typeof this.options.insert)switch(this.options.insert){case"before":this.element.parentNode.insertBefore(this._player,this.element);break;case"after":this.element.parentNode.insertBefore(this._player,this.element.nextSibling);break;default:this.element.insertBefore(this._player,this.element.firstChild)}else this.options.insert(this.element,this._player)},u.init=function(e){if(void 0===e&&(e={}),"SpeechSynthesisUtterance"in s){(p=new SpeechSynthesisUtterance).volume=1,p.pitch=1,p.rate=1,h=speechSynthesis.getVoices(),speechSynthesis.addEventListener("voiceschanged",function(){h=speechSynthesis.getVoices()});var t=Object.assign(r,e),e=t.selector||"";return e.length?Array.from(n.querySelectorAll(e)).map(function(e){return new u(e,t)}):[]}return[]},"undefined"!=typeof exports?exports.Speakable=u:s.Speakable=u}("undefined"!=typeof global?global:window,document);